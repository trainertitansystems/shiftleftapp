name: Shift-Left CI (Tests â€¢ Coverage â€¢ Security â€¢ CodeQL â€¢ Sonar)

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

jobs:
  shiftleft:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------
      # Python setup
      # ----------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      # ----------------------------
      # Install dependencies
      # ----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r autoscale_demo/requirements.txt
          pip install pytest pytest-cov bandit pip-audit jq

      # ----------------------------
      # Unit + Integration tests
      # ----------------------------
      - name: Run tests with coverage
        env:
          PYTHONPATH: autoscale_demo
        run: |
          pytest autoscale_demo/tests \
            --ignore=autoscale_demo/tests/smoke \
            --cov=autoscale_demo/app \
            --cov-report=xml:coverage.xml \
            --cov-report=term

      # ----------------------------
      # Extract coverage %
      # ----------------------------
      - name: Parse coverage
        id: coverage
        run: |
          RATE=$(grep -oP 'line-rate="\K[0-9.]+' coverage.xml | head -1)
          PERCENT=$(python - <<EOF
print(round(float("$RATE") * 100, 2))
EOF
)
          echo "coverage=$PERCENT" >> $GITHUB_OUTPUT

      # ----------------------------
      # Dependency vulnerability scan
      # ----------------------------
      - name: pip-audit
        run: |
          pip-audit -r autoscale_demo/requirements.txt -f json > pip-audit.json || true

      - name: Parse pip-audit results
        id: deps
        run: |
          HIGH=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' pip-audit.json)
          CRITICAL=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' pip-audit.json)
          LOW=$(jq '[.vulnerabilities[] | select(.severity=="low")] | length' pip-audit.json)
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

      # ----------------------------
      # Static code security scan
      # ----------------------------
      - name: Bandit scan
        run: |
          bandit -r autoscale_demo/app -f json -o bandit.json || true

      - name: Parse bandit results
        id: bandit
        run: |
          HIGH=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit.json)
          MEDIUM=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit.json)
          LOW=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' bandit.json)
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

      # ----------------------------
      # CodeQL (no Docker required)
      # ----------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # ----------------------------
      # SonarCloud (secrets scoped correctly)
      # ----------------------------
      - name: SonarCloud Scan
        environment: shiftleft   # âœ… ONLY HERE
        uses: SonarSource/sonarcloud-github-action@v3
        with:
          projectBaseDir: autoscale_demo
          args: >
            -Dsonar.projectKey=trainertitansystems_shiftleftapp
            -Dsonar.organization=trainertitansystems
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.qualitygate.wait=false
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # ----------------------------
      # PR Summary Comment
      # ----------------------------
      - name: Publish PR summary
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat <<EOF > summary.md
### âœ… Shift-Left Preflight Report

| Check | Result |
|------|--------|
| ğŸ§ª Unit & Integration Tests | Passed |
| ğŸ“Š Code Coverage | **${{ steps.coverage.outputs.coverage }}%** |
| ğŸ”’ Dependency Vulnerabilities | Low: ${{ steps.deps.outputs.low }}, High: ${{ steps.deps.outputs.high }}, Critical: ${{ steps.deps.outputs.critical }} |
| ğŸ” Bandit Issues | Low: ${{ steps.bandit.outputs.low }}, Medium: ${{ steps.bandit.outputs.medium }}, High: ${{ steps.bandit.outputs.high }} |
| ğŸ›¡ï¸ CodeQL | Completed |
| ğŸ“ˆ SonarQube | Executed (Quality Gate in Sonar) |

_This report runs on every push and PR._
EOF

          gh pr comment ${{ github.event.pull_request.number }} --body-file summary.md
