name: PR CI – Tests, Security & Gemini Review

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

jobs:
  pr-ci:
    runs-on: ubuntu-latest
    environment: shiftleft

    steps:
      # -------------------------
      # Checkout
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------
      # Python setup
      # -------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      # -------------------------
      # Install dependencies
      # -------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r autoscale_demo/requirements.txt
          pip install pytest pytest-cov bandit pip-audit

      # -------------------------
      # Tests + Coverage
      # -------------------------
      - name: Run unit & integration tests with coverage
        continue-on-error: true
        run: |
          pytest autoscale_demo/tests \
            --ignore=autoscale_demo/tests/smoke \
            --cov=autoscale_demo/app \
            --cov-report=xml \
            --cov-report=term > pytest_output.txt || true

      - name: Coverage summary
        continue-on-error: true
        run: |
          coverage report > coverage_summary.txt || true

      # -------------------------
      # Security scans
      # -------------------------
      - name: Bandit scan
        continue-on-error: true
        run: |
          bandit -r autoscale_demo/app -f json -o bandit.json || true

      - name: pip-audit scan
        continue-on-error: true
        run: |
          pip-audit -r autoscale_demo/requirements.txt -f json -o pip_audit.json || true

      # -------------------------
      # Git diff for AI review
      # -------------------------
      - name: Capture PR diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt

      # -------------------------
      # Preflight secret check
      # -------------------------
      - name: Preflight – check Gemini API key
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "❌ GEMINI_API_KEY is NOT available"
            exit 1
          else
            echo "✅ GEMINI_API_KEY is available"
          fi

      # -------------------------
      # Gemini AI Review
      # -------------------------
      - name: Run Gemini AI Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python .github/scripts/gemini_pr_review.py

      # -------------------------
      # Post as PR REVIEW (not comment)
      # -------------------------
      - name: Post PR Review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('final_review.md', 'utf8');

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body,
              event: "COMMENT"
            });

      # -------------------------
      # CodeQL (GitHub-native)
      # -------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

