name: Shift-Left CI (Tests â€¢ Coverage â€¢ Security â€¢ CodeQL)
#test
on:
  # 1ï¸âƒ£ Run immediately when code is pushed to ANY temp branch
  push:
    branches-ignore:
      - main
      - master
      - dev
      - staging
      - prod

  # 2ï¸âƒ£ Re-run when PR is opened or updated
  pull_request:
    branches:
      - main
      - master
      - dev
      - staging
      - prod

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------
      # Checkout EXACT branch that triggered the run
      # ----------------------------------
      - name: Checkout code (temp / PR branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------
      # Python setup
      # ----------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      # ----------------------------------
      # Install dependencies
      # ----------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r autoscale_demo/requirements.txt
          pip install pytest pytest-cov bandit pip-audit

      # ----------------------------------
      # Unit + Integration tests with coverage
      # ----------------------------------
      - name: Run unit & integration tests
        env:
          PYTHONPATH: autoscale_demo
        run: |
          pytest autoscale_demo/tests \
            --ignore=autoscale_demo/tests/smoke \
            --cov=autoscale_demo/app \
            --cov-report=xml \
            --cov-report=term

      # ----------------------------------
      # Dependency vulnerability scan
      # ----------------------------------
      - name: Dependency scan (pip-audit)
        run: |
          pip-audit -r autoscale_demo/requirements.txt

      # ----------------------------------
      # Static security scan
      # ----------------------------------
      - name: Static security scan (Bandit)
        run: |
          bandit -r autoscale_demo/app -ll

      # ----------------------------------
      # CodeQL Security Analysis (NO Docker required)
      # ----------------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # ----------------------------------
      # CI Summary (shows in run & PR)
      # ----------------------------------
      - name: Publish CI summary
        run: |
          echo "## âœ… Shift-Left CI Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests & Coverage | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ pip-audit | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ Bandit | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§  CodeQL | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Triggered from branch:_ **${GITHUB_REF_NAME}**" >> $GITHUB_STEP_SUMMARY

